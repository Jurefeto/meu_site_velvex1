<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Carrinho - Velvex</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <header class="site-header">
        <div class="search-area">
            <a href="#" id="openSearchPopup">Pesquisar</a>
        </div>
        <nav class="main-nav">
            <a href="{{ url_for('home') }}">In√≠cio</a>
            <a href="{{ url_for('loja_page') }}">Loja (Criar An√∫ncio)</a>
            <a href="{{ url_for('anuncios_page') }}">Anuncios</a> 
        </nav>
        <div class="account-area">
            {% if session.user_id %}
                <a href="{{ url_for('minha_conta_page') }}">{{ session.user_nome }}</a>
                {% if session.is_admin %}
                    <a href="{{ url_for('admin_dashboard') }}" class="admin-link">Admin</a> 
                {% endif %}
                <a href="{{ url_for('logout') }}">Logout</a>
            {% else %}
                <a href="{{ url_for('login_page') }}">Minha Conta / Login</a>
            {% endif %}
            {# Link do Carrinho no cabe√ßalho #}
            <a href="{{ url_for('carrinho_page') }}" class="cart-link">üõí Carrinho</a>
        </div>
    </header>

    <main class="page-content-container">
        <h2 class="section-title">Meu Carrinho</h2>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <ul class="flash-messages">
                {% for category, message in messages %}
                    <li class="flash-message flash-{{ category }}">{{ message }}</li>
                {% endfor %}
                </ul>
            {% endif %}
        {% endwith %}

        {% if itens_carrinho %}
            <div class="table-responsive cart-table-container">
                <table class="modern-table cart-table">
                    <thead>
                        <tr>
                            <th>Produto</th>
                            <th>Pre√ßo Unit√°rio</th>
                            <th>Quantidade</th>
                            <th>Subtotal</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in itens_carrinho %}
                        {% set primeira_imagem = (item.anuncio.imagens_nomes.split(',')[0]).strip() if item.anuncio.imagens_nomes else None %}
                        <tr>
                            <td>
                                <div class="cart-product-info">
                                    {% if primeira_imagem %}
                                        <img src="{{ url_for('static', filename='uploads/anuncios/' + primeira_imagem) }}" alt="{{ item.anuncio.titulo }}" class="cart-thumbnail">
                                    {% else %}
                                        <div class="no-image-placeholder">Sem Imagem</div>
                                    {% endif %}
                                    <a href="#" class="view-anuncio-link"
                                        data-id="{{ item.anuncio.id }}"
                                        data-titulo="{{ item.anuncio.titulo }}"
                                        data-descricao="{{ item.anuncio.descricao }}"
                                        data-preco="{{ "%.2f"|format(item.anuncio.preco|float) }}"
                                        data-categoria="{{ item.anuncio.categoria }}"
                                        data-condicao="{{ item.anuncio.condicao }}"
                                        data-imagens="{{ item.anuncio.imagens_nomes if item.anuncio.imagens_nomes else '' }}"
                                        data-seller-id="{{ item.anuncio.user_id }}">
                                        {{ item.anuncio.titulo }}
                                    </a>
                                </div>
                            </td>
                            <td>R$ {{ "%.2f"|format(item.anuncio.preco|float) }}</td>
                            <td>
                                <form action="{{ url_for('atualizar_quantidade_carrinho_action', item_carrinho_id=item.id) }}" method="POST" class="update-quantity-form inline-form">
                                    {# Removido: {{ form.csrf_token }} #}
                                    <input type="number" name="quantidade" value="{{ item.quantidade }}" min="1" class="quantity-input">
                                    <button type="submit" class="btn-action btn-update-quantity">Atualizar</button>
                                </form>
                            </td>
                            <td>R$ {{ "%.2f"|format(item.anuncio.preco * item.quantidade|float) }}</td>
                            <td>
                                <form action="{{ url_for('remover_item_carrinho_action', item_carrinho_id=item.id) }}" method="POST" class="inline-form" onsubmit="return confirm('Tem certeza que deseja remover este item do carrinho?');">
                                    {# Removido: {{ form.csrf_token }} #}
                                    <button type="submit" class="btn-action btn-remove-item">Remover</button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="cart-summary">
                <h3>Total do Carrinho: R$ {{ "%.2f"|format(total_carrinho) }}</h3>
                <a href="{{ url_for('checkout_page') }}" class="btn-principal btn-checkout">Finalizar Compra</a>
            </div>

        {% else %}
            <p class="no-ads-message">Seu carrinho est√° vazio. <a href="{{ url_for('anuncios_page') }}">Explore nossos an√∫ncios!</a></p>
        {% endif %}
    </main>

    {# Pop-up de Busca (Search Popup) #}
    <div id="searchPopup" class="search-popup-overlay">
        <div class="search-popup-content">
            <span class="close-popup" id="closeSearchPopup">&times;</span>
            <h2>Pesquisar no Site</h2>
            <form action="{{ url_for('search_results_page') }}" method="get" class="popup-search-form">
                <input type="search" name="query_popup" placeholder="O que voc√™ procura?" aria-label="Campo de busca popup">
                <button type="submit" class="btn-principal">Buscar</button>
            </form>
            <p class="popup-info-text">(Busca nos an√∫ncios do site.)</p>
        </div>
    </div>

    {# Pop-up de Detalhes do An√∫ncio (para cliques em links de produtos no carrinho) #}
    <div id="anuncioDetalhePopup" class="anuncio-popup-overlay">
        <div class="anuncio-popup-content">
            <span class="close-anuncio-popup" id="closeAnuncioDetalhePopup">&times;</span>
            <div class="anuncio-popup-gallery-column">
                <div class="image-nav-wrapper">
                    <button class="popup-gallery-nav prev" id="prevImagePopup">&lt;</button>
                    <div class="anuncio-popup-imagem-principal-container">
                        <img id="popupAnuncioImgPrincipal" src="" alt="Imagem Principal do An√∫ncio" class="anuncio-popup-imagem-principal">
                    </div>
                    <button class="popup-gallery-nav next" id="nextImagePopup">&gt;</button>
                </div>
                <div id="popupAnuncioThumbnails" class="anuncio-popup-thumbnails"></div>
            </div>
            <div class="anuncio-popup-info">
                <h2 id="popupAnuncioTitulo"></h2>
                <p class="popup-anuncio-preco"><strong>Pre√ßo:</strong> R$ <span id="popupAnuncioPreco"></span></p>
                <p><strong>Categoria:</strong> <span id="popupAnuncioCategoria"></span></p>
                <p><strong>Condi√ß√£o:</strong> <span id="popupAnuncioCondicao"></span></p>
                <p id="popupAnuncioDescricao" class="popup-anuncio-descricao-completa"></p>
                <div class="anuncio-popup-actions-group">
                    {# A√ß√µes (Comprar/Ofertar) n√£o s√£o relevantes aqui, e n√£o ter√£o bot√µes nesse popup #}
                </div>
            </div>
        </div>
    </div>


    <script>
        // Helper function to capitalize first letter and replace underscores
        String.prototype.capitalize = function() {
            return this.replace(/\b\w/g, char => char.toUpperCase()).replace(/_/g, ' ');
        };

        // --- Pop-up de Busca (Search Popup) ---
        const openSearchButton = document.getElementById('openSearchPopup');
        const closeSearchButton = document.getElementById('closeSearchPopup');
        const searchPopupOverlay = document.getElementById('searchPopup');

        if(openSearchButton && searchPopupOverlay){
            openSearchButton.addEventListener('click', function(event){
                event.preventDefault();
                searchPopupOverlay.classList.add('active');
            });
        }
        if(closeSearchButton && searchPopupOverlay){
            closeSearchButton.addEventListener('click', function(){
                searchPopupOverlay.classList.remove('active');
            });
        }
        if(searchPopupOverlay){
            searchPopupOverlay.addEventListener('click', function(event){
                if(event.target === searchPopupOverlay){
                    searchPopupOverlay.classList.remove('active');
                }
            });
        }

        // --- Pop-up de Detalhes do An√∫ncio (Anuncio Detalhe Popup) ---
        // Reutilizando o JS do anuncios.html para abrir o pop-up de detalhes a partir dos links de produto no carrinho
        const viewAnuncioLinks = document.querySelectorAll('.view-anuncio-link'); // Links de produtos no carrinho
        const anuncioDetalhePopup = document.getElementById('anuncioDetalhePopup');
        const closeAnuncioDetalheButton = document.getElementById('closeAnuncioDetalhePopup');
        
        let currentPopupImages = [];
        let currentImageIndex = 0;
        let currentAnuncioIdForActions = null; 
        let currentSellerId = null; 

        if (viewAnuncioLinks.length > 0 && anuncioDetalhePopup) {
            const el = { // Elementos do pop-up
                imgPrincipal: document.getElementById('popupAnuncioImgPrincipal'),
                thumbnailsContainer: document.getElementById('popupAnuncioThumbnails'),
                titulo: document.getElementById('popupAnuncioTitulo'),
                descricao: document.getElementById('popupAnuncioDescricao'),
                preco: document.getElementById('popupAnuncioPreco'),
                categoria: document.getElementById('popupAnuncioCategoria'),
                condicao: document.getElementById('popupAnuncioCondicao'),
                prevBtn: document.getElementById('prevImagePopup'),
                nextBtn: document.getElementById('nextImagePopup'),
                // Note: Bot√µes de oferta/compra n√£o s√£o necess√°rios aqui, mas os IDs existem para compatibilidade
                // btnMakeOffer: document.getElementById('btnMakeOfferPopup'), 
                // buyNowForm: document.getElementById('buyNowForm'), 
                // offerLoginPrompt: anuncioDetalhePopup.querySelector('.offer-login-prompt') 
            };

            function displayCurrentImageInPopup() {
                if (el.imgPrincipal && currentPopupImages.length > 0) {
                    el.imgPrincipal.src = "{{ url_for('static', filename='uploads/anuncios/') }}" + currentPopupImages[currentImageIndex];
                    el.imgPrincipal.alt = el.titulo.textContent || "Imagem Principal";
                    el.imgPrincipal.style.display = 'block';
                } else if (el.imgPrincipal) {
                    el.imgPrincipal.src = ""; 
                    el.imgPrincipal.alt = "Sem imagem"; 
                    el.imgPrincipal.style.display = 'none';
                }
                if(el.thumbnailsContainer) {
                    const thumbnails = el.thumbnailsContainer.querySelectorAll('.anuncio-popup-thumbnail-item');
                    thumbnails.forEach((thumb, index) => { 
                        thumb.classList.toggle('active-thumbnail', index === currentImageIndex);
                    });
                }
                if(el.prevBtn) el.prevBtn.disabled = currentImageIndex === 0;
                if(el.nextBtn) el.nextBtn.disabled = currentImageIndex >= currentPopupImages.length - 1;
            }
            
            viewAnuncioLinks.forEach(link => {
                link.addEventListener('click', function(event) {
                    event.preventDefault(); // Impede o link de navegar
                    currentAnuncioIdForActions = this.dataset.id; 
                    currentSellerId = this.dataset.sellerId; 
                    
                    if (el.titulo) el.titulo.textContent = this.dataset.titulo || "N/A";
                    if (el.descricao) el.descricao.textContent = this.dataset.descricao || "N/A";
                    if (el.preco) el.preco.textContent = this.dataset.preco || "0.00";
                    if (el.categoria) el.categoria.textContent = (this.dataset.categoria || "N/A").replace(/_/g,' ').capitalize();
                    if (el.condicao) el.condicao.textContent = (this.dataset.condicao || "N/A").replace(/_/g,' ').capitalize();
                    
                    const imagensNomesStr = this.dataset.imagens;
                    currentPopupImages = []; 
                    if (el.thumbnailsContainer) el.thumbnailsContainer.innerHTML = ''; 

                    if (imagensNomesStr) { 
                        currentPopupImages = imagensNomesStr.split(',').map(s => s.trim()).filter(s => s); 
                    }
                    currentImageIndex = 0; 
                    displayCurrentImageInPopup(); 

                    if (el.thumbnailsContainer && currentPopupImages.length > 0) {
                        currentPopupImages.forEach((imgNome, index) => {
                            const thumb = document.createElement('img');
                            thumb.src = "{{ url_for('static', filename='uploads/anuncios/') }}" + imgNome;
                            thumb.alt = "Miniatura " + (index + 1);
                            thumb.classList.add('anuncio-popup-thumbnail-item');
                            thumb.dataset.index = index; 
                            thumb.addEventListener('click', function() { 
                                currentImageIndex = parseInt(this.dataset.index); 
                                displayCurrentImageInPopup(); 
                            });
                            el.thumbnailsContainer.appendChild(thumb);
                        });
                        const thumbnails = el.thumbnailsContainer.querySelectorAll('.anuncio-popup-thumbnail-item');
                        if (thumbnails.length > currentImageIndex) thumbnails[currentImageIndex].classList.add('active-thumbnail');
                    }
                    
                    // Nao tem botoes de acao (editar/deletar/comprar/ofertar) nesse popup no carrinho
                    const actionsGroup = anuncioDetalhePopup.querySelector('.anuncio-popup-actions-group');
                    if (actionsGroup) actionsGroup.style.display = 'none'; // Certifica que o grupo de a√ß√µes est√° oculto
                    // Se voc√™ tiver outros elementos espec√≠ficos de a√ß√£o no popup que n√£o s√£o do grupo, tamb√©m os oculte aqui.


                    anuncioDetalhePopup.classList.add('active');
                });
            });

            if(el.prevBtn) {el.prevBtn.addEventListener('click', function() {if (currentImageIndex > 0) {currentImageIndex--;displayCurrentImageInPopup();}}); }
            if(el.nextBtn) {el.nextBtn.addEventListener('click', function() {if (currentImageIndex < currentPopupImages.length - 1) {currentImageIndex++;displayCurrentImageInPopup();}}); }
            if (closeAnuncioDetalheButton) {closeAnuncioDetalheButton.addEventListener('click', function() {anuncioDetalhePopup.classList.remove('active'); });}
            if (anuncioDetalhePopup) { anuncioDetalhePopup.addEventListener('click', function(event) { if (event.target === anuncioDetalhePopup) { anuncioDetalhePopup.classList.remove('active'); } });}
        }
    </script>
</body>
</html>